<!DOCTYPE html>
<html>
	<head>
		<link rel="icon" type="image/x-icon" href="/favicon.ico" />
		<link rel="stylesheet" type="text/css" href="/theme.css" />
		<script src="/background.js"></script>
		<link rel="stylesheet" type="text/css" href="/table.css" />
		<link rel="stylesheet" type="text/css" href="/badges.css" />
		<style>
h2 {
	color: white;
}
.disabled {
	opacity: 0.75;
	text-decoration: line-through;
}
.disabled > :is(input, br) {
	display: none;
}
.badgev {
	width: 4em;
}
		</style>
	</head>
	<body>
		<div class="tabs"></div>
		<h1>Admin Board</h1>
		<h3>Applications:</h3>
		<div id="applications"></div>
		<h3>Update Event List:</h3>
		<p>To get the file, go to the Google Sheets event list, then click on File > Export > Comma Separated Values. Then upload the file here.</p>
		<p><input type="file" id="eventList"><button onclick="this.previousElementSibling.files[0].text().then((e) => uploadCSV(e))">Upload</button></p>
		<h3>Add New Event</h3>
		<div>Name: <input type="text" id="new-event-name"></div>
		<div>Is specialty leaderboard: <input type="checkbox" id="specialty" oninput="if(this.checked){this.parentNode.nextElementSibling.classList.add('disabled')}else{this.parentNode.nextElementSibling.classList.remove('disabled')}"></div>
		<div>Badges:<br>
			Novice <input type="number" class="badgev"><br>
			Vassal <input type="number" class="badgev"><br>
			Apprentice <input type="number" class="badgev"><br>
			Prospect <input type="number" class="badgev"><br>
			Artisan <input type="number" class="badgev"><br>
			Expert <input type="number" class="badgev"><br>
			Master <input type="number" class="badgev"><br>
			Ultimate Master <input type="number" class="badgev"><br>
			Badge Description (put %s in place of badge value):<br><input type="text" style="width: 60em; margin-left: 2em;" id="desc-badge">
		</div>
		<div>Leaderboard Description:<br><input type="text" style="width: 60em; margin-left: 2em;" id="desc-event"></div>
		<div>Best score: <select id="bestscore"><option value="false">Highest</option><option value="true">Lowest</option></select></div>
		<div><input type="checkbox" id="istime"> Is time leaderboard</div>
		<div><button onclick="addLeaderboard()">Add Leaderboard</button></div>
		<script src="/data.js"></script>
		<script src="/tabs.js"></script>
		<script>
tabs.extra(3, "Admin Board")
getData().then((info) => {
	tabs.userfix(info.profile);
	if (info.profile.length == 0) return location.replace("/")
	if (info.profile[0].admin == false) return location.replace("/")
});
// APPLICATION VIEWER CODE
(() => {
	var x = new XMLHttpRequest()
	x.open("GET", "/applications.txt" + location.search)
	x.addEventListener("loadend", (e) => {
		var t = e.target.responseText
		var h = t.replaceAll(/(Username: ([A-Za-z0-9 \._]+)\nEmail address: ([A-Za-z0-9@\.]+)?\n)(?!\[(Rejected|Accepted)\])/ig, "$1<button onclick=\"createprofile('$2', '$3')\">Accept</button><button onclick=\"rejectprofile('$2', '$3')\">Reject</button>\n")
		h = h.replaceAll(/^\n*$/ig, "There are no applications at the moment.")
		if (h == t) h += "\nThere are no valid applications at the moment."
		document.querySelector("#applications").innerHTML = h
	})
x.send()
})();
function createprofile(username, email) {
	var x = new XMLHttpRequest()
	x.open("POST", "/createuser")
	x.addEventListener("loadend", () => location.reload())
	x.send(`${username}\n${email}`)
}
function rejectprofile(username, email) {
	var x = new XMLHttpRequest()
	x.open("POST", "/rejectprofile")
	x.addEventListener("loadend", () => location.reload())
	x.send(`${username}\n${email}`)
}
// EVENT LIST CODE
function uploadCSV(data) {
	var x = new XMLHttpRequest()
	x.open("POST", "/upload_csv")
	x.addEventListener("loadend", () => location.replace("/"))
	x.send(location.search.substr(1) + "\n" + data)
}
// Add a single event:
function addLeaderboard() {
	var q = (e) => document.getElementById(e)
	var isSpecialty = q("specialty").checked
	var data = {
		"name": q("new-event-name").value,
		"data": {
			"badges": isSpecialty ? [] :
				[...document.querySelectorAll(".badgev")].map((v) => v.valueAsNumber),
			"badge_desc": isSpecialty ? "" : q("desc-badge").value,
			"leaderboard_desc": q("desc-event").value,
			"entries": [],
			"reverseOrder": q("bestscore").value == "true",
			"isTime": q("istime").checked
		}
	}
	var x = new XMLHttpRequest()
	x.open("POST", "/add_event")
	x.send(JSON.stringify(data))
}
		</script>
		<!--<script src="https://matterjstest.jasonroman.repl.co/matter.js"></script>-->
		<!--<script src="/matter2.js"></script>-->
	</body>
</html>